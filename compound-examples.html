<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyperFixi - Compound Hyperscript Examples</title>

    <!-- Test Navigation -->
    <script src="packages/core/test-nav.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        /* Debug Toggle Button */
        #debug-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: #333;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }

        #debug-toggle:hover {
            background: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }

        #debug-toggle:active {
            transform: translateY(0);
        }

        #debug-toggle.enabled {
            background: #28a745;
        }

        .demo-section {
            background: white;
            margin: 20px 0;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }

        h2 {
            color: #555;
            margin-top: 0;
        }

        .description {
            background: #f8f9fa;
            padding: 15px;
            border-left: 4px solid #007bff;
            margin: 15px 0;
            border-radius: 4px;
        }

        .code-block {
            background: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            margin: 15px 0;
        }

        .code-block .keyword {
            color: #c678dd;
        }

        .code-block .string {
            color: #98c379;
        }

        .code-block .comment {
            color: #5c6370;
            font-style: italic;
        }

        /* Example 1: HSL Color Cycling */
        #color-box {
            width: 300px;
            height: 200px;
            background: hsl(200, 100%, 90%);
            border: 3px solid #333;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #color-box:active {
            transform: scale(0.98);
        }

        /* Example 2: Draggable Items */
        .draggable-container {
            position: relative;
            min-height: 400px;
            background: #f8f9fa;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
        }

        .draggable-item {
            position: absolute;
            width: 200px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: move;
            user-select: none;
            transition: box-shadow 0.2s ease;
        }

        .draggable-item.dragging {
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .titlebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 8px 8px 0 0;
            cursor: move;
            font-weight: bold;
        }

        .content {
            padding: 15px;
            color: #333;
        }

        #item1 {
            top: 20px;
            left: 20px;
        }

        #item2 {
            top: 20px;
            left: 280px;
        }

        #item3 {
            top: 180px;
            left: 20px;
        }

        .status {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 13px;
            color: #1976d2;
        }

        .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .success-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <!-- Debug Toggle Button -->
    <button id="debug-toggle" onclick="toggleDebug()">
        üêõ Debug: OFF
    </button>

    <h1>üéØ HyperFixi - Compound Hyperscript Examples</h1>

    <div class="description">
        <strong>Pure Hyperscript Validation</strong> - These examples use ONLY hyperscript, with zero JavaScript.
        They demonstrate complex, real-world patterns including event loops, behavior definitions, and dynamic styling.
    </div>

    <script>
        // Initialize debug button state
        function initDebugButton() {
            const isEnabled = window.__HYPERFIXI_DEBUG__ === true;
            const button = document.getElementById('debug-toggle');
            if (isEnabled) {
                button.textContent = 'üêõ Debug: ON';
                button.classList.add('enabled');
            } else {
                button.textContent = 'üêõ Debug: OFF';
                button.classList.remove('enabled');
            }
        }

        // Toggle debug mode
        function toggleDebug() {
            const currentState = window.__HYPERFIXI_DEBUG__ === true;
            const newState = !currentState;

            // Store in localStorage to persist across reloads
            if (newState) {
                localStorage.setItem('__HYPERFIXI_DEBUG__', 'true');
                window.__HYPERFIXI_DEBUG__ = true;
            } else {
                localStorage.removeItem('__HYPERFIXI_DEBUG__');
                window.__HYPERFIXI_DEBUG__ = false;
            }

            // Reload page to apply debug settings
            location.reload();
        }

        // Check localStorage on page load
        if (localStorage.getItem('__HYPERFIXI_DEBUG__') === 'true') {
            window.__HYPERFIXI_DEBUG__ = true;
        }

        // Initialize button state when page loads
        window.addEventListener('DOMContentLoaded', initDebugButton);
    </script>

    <!-- Example 1: HSL Color Cycling -->
    <div class="demo-section">
        <h2>üåà Example 1: HSL Color Cycling on Pointer Hold <span class="success-badge">PURE HYPERSCRIPT</span></h2>

        <div class="description">
            <p><strong>Pattern:</strong> Loop-based event handling with dynamic color generation</p>
            <p><strong>Features tested:</strong></p>
            <ul>
                <li><code>on pointerdown</code> - Pointer event handling</li>
                <li><code>repeat until event pointerup from the document</code> - Event-driven loops</li>
                <li><code>Math.random()</code> - Global object access</li>
                <li>Template string interpolation with backticks</li>
                <li><code>transition</code> - CSS transitions</li>
            </ul>
        </div>

        <div class="code-block">
<span class="keyword">on</span> pointerdown
  <span class="keyword">set</span> originalColor <span class="keyword">to</span> <span class="keyword">my</span> *background-color
  <span class="keyword">repeat until</span> <span class="keyword">event</span> pointerup <span class="keyword">from</span> <span class="keyword">the</span> document
    <span class="keyword">set</span> rand <span class="keyword">to</span> Math.random() * 360
    <span class="keyword">transition</span>
      *background-color
      <span class="keyword">to</span> <span class="string">`hsl(${rand} 100% 90%)`</span>
      <span class="keyword">over</span> 250ms
  <span class="keyword">end</span>
  <span class="keyword">transition</span> *background-color <span class="keyword">to</span> originalColor
<span class="keyword">end</span>
        </div>

        <div class="status">
            üìù Instructions: Press and hold on the box below. Watch the colors cycle while you hold!
        </div>

        <div id="color-box"
             _="on pointerdown
                  set originalColor to my *background-color
                  repeat until event pointerup from the document
                    set rand to Math.random() * 360
                    transition
                      *background-color
                      to `hsl(${rand} 100% 90%)`
                      over 250ms
                  end
                  transition *background-color to originalColor
                end">
            Press & Hold Me!
        </div>
    </div>

    <!-- Example 2: Draggable Behavior -->
    <div class="demo-section">
        <h2>üñ±Ô∏è Example 2: Draggable Behavior Pattern <span class="success-badge">PURE HYPERSCRIPT</span></h2>

        <div class="description">
            <p><strong>Pattern:</strong> Reusable behavior with parameters and custom events</p>
            <p><strong>Features tested:</strong></p>
            <ul>
                <li><code>behavior</code> - Behavior definition with parameters</li>
                <li><code>install</code> - Behavior installation</li>
                <li><code>init</code> - Initialization logic</li>
                <li><code>halt the event</code> - Event propagation control</li>
                <li><code>trigger</code> - Custom events</li>
                <li><code>measure</code> - Element position measurement</li>
                <li><code>wait for</code> - Multiple event waiting</li>
                <li>Template string CSS injection</li>
            </ul>
        </div>

        <div class="code-block">
<span class="comment">-- Usage: _="install Draggable(dragHandle: .titlebar in me)"</span>

<span class="keyword">behavior</span> Draggable(dragHandle)
  <span class="keyword">init</span>
    <span class="keyword">if no</span> dragHandle <span class="keyword">set the</span> dragHandle <span class="keyword">to</span> me
  <span class="keyword">end</span>
  <span class="keyword">on</span> pointerdown(clientX, clientY) <span class="keyword">from</span> dragHandle
    <span class="keyword">halt the event</span>
    <span class="keyword">trigger</span> draggable:start <span class="comment">-- hooks, e.g. for adding a drop shadow</span>
    <span class="keyword">measure</span> my x, y
    <span class="keyword">set</span> xoff <span class="keyword">to</span> clientX - x
    <span class="keyword">set</span> yoff <span class="keyword">to</span> clientY - y
    <span class="keyword">repeat until</span> <span class="keyword">event</span> pointerup <span class="keyword">from</span> document
      <span class="keyword">wait for</span> pointermove(pageX, pageY) <span class="keyword">or</span>
                 pointerup  (pageX, pageY) <span class="keyword">from</span> document
      <span class="keyword">add</span> <span class="string">{ left: ${pageX - xoff}px; top: ${pageY - yoff}px; }</span>
      <span class="keyword">trigger</span> draggable:move
    <span class="keyword">end</span>
    <span class="keyword">trigger</span> draggable:end
  <span class="keyword">end</span>
<span class="keyword">end</span>
        </div>

        <div class="note" style="background: #d4edda; border-left-color: #28a745;">
            ‚úÖ <strong>Fully Working:</strong> This example demonstrates the complete behavior system implementation,
            including custom event triggers, event loops, and the measure command with both position and CSS properties.
        </div>

        <div class="status">
            üìù Instructions: Drag the boxes by their title bars. Custom events are triggered during drag operations.
        </div>

        <div class="draggable-container">
            <div id="item1" class="draggable-item"
                 _="install Draggable(dragHandle: .titlebar in me)
                    on draggable:start add .dragging
                    on draggable:end remove .dragging">
                <div class="titlebar">üì¶ Draggable Item 1</div>
                <div class="content">Drag me by the title bar!</div>
            </div>

            <div id="item2" class="draggable-item"
                 _="install Draggable(dragHandle: .titlebar in me)
                    on draggable:start add .dragging
                    on draggable:end remove .dragging">
                <div class="titlebar">üì¶ Draggable Item 2</div>
                <div class="content">I'm draggable too!</div>
            </div>

            <div id="item3" class="draggable-item"
                 _="install Draggable(dragHandle: .titlebar in me)
                    on draggable:start add .dragging
                    on draggable:end remove .dragging">
                <div class="titlebar">üì¶ Draggable Item 3</div>
                <div class="content">Move me around!</div>
            </div>
        </div>
    </div>

    <!-- Load HyperFixi -->
    <script>
        // Cache busting for development - force fresh load
        const script = document.createElement('script');
        script.src = 'packages/core/dist/hyperfixi-browser.js?v=' + Date.now();
        document.write(script.outerHTML);
    </script>

    <!-- Define Draggable Behavior in Hyperscript -->
    <script type="text/hyperscript">
behavior Draggable(dragHandle)
  init
    if no dragHandle set the dragHandle to me
  end
  on pointerdown(clientX, clientY) from dragHandle
    halt the event
    trigger draggable:start
    measure x
    set startX to it
    measure y
    set startY to it
    set xoff to clientX - startX
    set yoff to clientY - startY
    repeat until event pointerup from document
      wait for pointermove(clientX, clientY) or
               pointerup(clientX, clientY) from document
      add { left: ${clientX - xoff}px; top: ${clientY - yoff}px; }
      trigger draggable:move
    end
    trigger draggable:end
  end
end
    </script>

    <script>
        // Pure JavaScript for status reporting only - NOT for implementing hyperscript features!
        window.addEventListener('load', () => {
            console.log('üöÄ HyperFixi Compound Examples Page Loaded');
            console.log('üìä HyperFixi Available:', typeof hyperfixi !== 'undefined');

            if (typeof hyperfixi !== 'undefined') {
                console.log('‚úÖ HyperFixi Methods:', Object.keys(hyperfixi));

                // Initialize hyperscript processing
                if (hyperfixi.processNode) {
                    console.log('üîß Processing hyperscript attributes...');
                    // Auto-process should happen via attribute processor
                }
            } else {
                console.error('‚ùå HyperFixi not loaded! Check /dist/hyperfixi-browser.js');
            }

            // Wire up debug toggle
            const debugToggle = document.getElementById('debug-toggle');
            if (debugToggle) {
                debugToggle.addEventListener('change', (e) => {
                    if (hyperfixi && hyperfixi.debug) {
                        hyperfixi.debug.enabled = e.target.checked;
                        console.log(e.target.checked ? 'üêõ Debug mode enabled' : 'üîï Debug mode disabled');
                    }
                });
            }
        });

        // ============================================================================
        // Object Pool Metrics Display
        // ============================================================================

        // Add metrics display to page
        const metricsPanel = document.createElement('div');
        metricsPanel.id = 'pool-metrics';
        metricsPanel.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: #0f0;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #0f0;
            box-shadow: 0 4px 12px rgba(0, 255, 0, 0.3);
            min-width: 280px;
            z-index: 10000;
        `;
        metricsPanel.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 10px; color: #fff; border-bottom: 1px solid #0f0; padding-bottom: 5px;">
                üìä Object Pool Metrics
            </div>
            <div id="metrics-content" style="line-height: 1.6;">
                <div>Allocations: <span id="metric-allocs">0</span></div>
                <div>Reuses: <span id="metric-reuses">0</span></div>
                <div>Hit Rate: <span id="metric-hit">0.0%</span></div>
                <div>Peak Pool: <span id="metric-peak">0</span></div>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #0f0; color: #aaa; font-size: 10px;">
                    Updates every 500ms
                </div>
            </div>
        `;
        document.body.appendChild(metricsPanel);

        // Update metrics display
        function updatePoolMetrics() {
            if (hyperfixi && hyperfixi.styleBatcher) {
                const metrics = hyperfixi.styleBatcher.getPoolMetrics();
                document.getElementById('metric-allocs').textContent = metrics.allocations;
                document.getElementById('metric-reuses').textContent = metrics.reuses;
                document.getElementById('metric-hit').textContent = metrics.hitRate.toFixed(1) + '%';
                document.getElementById('metric-peak').textContent = metrics.peakPoolSize;
            }
        }

        // Update metrics every 500ms
        setInterval(updatePoolMetrics, 500);
        updatePoolMetrics(); // Initial update

        // Also expose to console for manual inspection
        window.getPoolMetrics = () => {
            if (hyperfixi && hyperfixi.styleBatcher) {
                const metrics = hyperfixi.styleBatcher.getPoolMetrics();
                console.table(metrics);
                console.log('Pool efficiency:', metrics.hitRate.toFixed(1) + '% hit rate');
                return metrics;
            }
            console.warn('StyleBatcher not available');
            return null;
        };

        console.log('üí° Tip: Call getPoolMetrics() to see object pool statistics');
    </script>
</body>
</html>
