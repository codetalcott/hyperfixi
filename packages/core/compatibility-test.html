<!DOCTYPE html>
<html>
<head>
    <title>HyperScript Compatibility Test</title>
</head>
<body>
    <div id="work-area"></div>
    
    <!-- Original _hyperscript library -->
    <script src="/dist/_hyperscript.js"></script>
    
    <!-- Our hyperfixi implementation -->
    <script src="/dist/hyperfixi-browser.js"></script>
    
    <script>
        // Setup compatibility helpers
        window.testResults = [];
        
        window.testExpression = async function(expression, context = {}) {
            try {
                // Use the correct API for both libraries
                let original, originalError;
                let ours, oursError;
                
                // Test _hyperscript
                try {
                    original = _hyperscript.evaluate(expression, context);
                } catch (err) {
                    originalError = err.message;
                }
                
                // Test hyperfixi
                try {
                    ours = await hyperfixi.evalHyperScript(expression, context);
                } catch (err) {
                    oursError = err.message;
                }
                
                // Both succeeded - compare values
                if (!originalError && !oursError) {
                    return { expression, original, ours, match: original === ours };
                }
                
                // Both failed - check if error messages are similar (compatibility)
                if (originalError && oursError) {
                    // For mixed operator errors, both should fail - that's compatible
                    const isMixedOperatorError = originalError.includes('parenthesize') || oursError.includes('parenthesize');
                    return { 
                        expression, 
                        original: `ERROR: ${originalError}`, 
                        ours: `ERROR: ${oursError}`, 
                        match: isMixedOperatorError 
                    };
                }
                
                // One succeeded, one failed - not compatible
                return { 
                    expression, 
                    original: originalError ? `ERROR: ${originalError}` : original, 
                    ours: oursError ? `ERROR: ${oursError}` : ours, 
                    match: false 
                };
                
            } catch (error) {
                return { expression, error: error.message, match: false };
            }
        };
        
        // Helper for context conversion - _hyperscript uses different context format
        window.testExpressionWithContext = async function(expression, context = {}) {
            try {
                // Convert our context format to _hyperscript format if needed
                let hyperschriptContext = context;
                if (context.locals) {
                    // _hyperscript expects variables in the root context
                    hyperschriptContext = { ...context, ...context.locals };
                }
                if (context.me) {
                    hyperschriptContext.me = context.me;
                }
                if (context.you) {
                    hyperschriptContext.you = context.you;
                }
                if (context.result) {
                    hyperschriptContext.it = context.result;
                }
                
                const original = _hyperscript.evaluate(expression, hyperschriptContext);
                const ours = await hyperfixi.evalHyperScript(expression, context);
                return { expression, original, ours, match: original === ours };
            } catch (error) {
                return { expression, error: error.message, match: false };
            }
        };
    </script>
</body>
</html>