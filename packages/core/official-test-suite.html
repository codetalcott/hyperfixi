<!DOCTYPE html>
<html lang="en">
<head>
    <title>HyperFixi vs Official _hyperscript Test Suite</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Mocha CSS -->
    <link rel="stylesheet" href="https://unpkg.com/mocha/mocha.css">
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            margin: 20px;
        }
        .test-header {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .compatibility-summary {
            display: flex;
            gap: 20px;
            margin: 10px 0;
        }
        .stat-box {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            text-align: center;
            min-width: 100px;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div class="test-header">
        <h1>ðŸŽ¯ HyperFixi vs Official _hyperscript Test Suite</h1>
        <p>Running the complete official _hyperscript test suite against HyperFixi implementation</p>
        <div class="compatibility-summary" id="summary">
            <div class="stat-box">
                <div class="stat-number" id="passed">-</div>
                <div class="stat-label">Passed</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="failed">-</div>
                <div class="stat-label">Failed</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="total">-</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="percent">-</div>
                <div class="stat-label">% Pass</div>
            </div>
        </div>
    </div>

    <!-- Work area for tests -->
    <div id="work-area" style="display: none;"></div>

    <!-- Mocha test output -->
    <div id="mocha"></div>

    <!-- Load testing libraries -->
    <script src="https://unpkg.com/chai/chai.js"></script>
    <script src="https://unpkg.com/mocha/mocha.js"></script>

    <!-- Load our HyperFixi implementation -->
    <script src="/dist/hyperfixi-browser.js"></script>

    <!-- Initialize Mocha -->
    <script>
        mocha.setup('bdd');
        should = chai.should();
        assert = chai.assert;
        
        // Set up compatibility globals that match _hyperscript test expectations
        window.evalHyperScript = hyperfixi.evalHyperScript;
        
        // Work area helpers
        window.clearWorkArea = function() {
            const workArea = document.getElementById('work-area');
            if (workArea) {
                workArea.innerHTML = '';
            }
        };

        // Make function for creating DOM elements with hyperscript behavior
        window.make = function(htmlString) {
            try {
                const container = document.createElement('div');
                container.innerHTML = htmlString;
                const element = container.firstElementChild;
                
                if (!element) {
                    throw new Error('Invalid HTML string');
                }
                
                const hyperschriptBehavior = element.getAttribute('_');
                if (hyperschriptBehavior) {
                    window.initHyperscriptBehavior(element, hyperschriptBehavior);
                }
                
                return element;
            } catch (error) {
                console.error('make() error:', error.message);
                throw error;
            }
        };
        
        // Initialize hyperscript behavior on an element (simplified version)
        window.initHyperscriptBehavior = function(element, behavior) {
            const eventHandlers = window.parseHyperscriptBehavior(behavior);
            
            for (const handler of eventHandlers) {
                element.addEventListener(handler.event, async function(evt) {
                    try {
                        const context = {
                            me: element,
                            you: null,
                            it: evt,
                            result: null,
                            locals: new Map(),
                            globals: new Map()
                        };
                        
                        await hyperfixi.evalHyperScript(handler.command, context);
                    } catch (error) {
                        console.error('Hyperscript behavior error:', error.message);
                    }
                });
            }
        };
        
        // Parse hyperscript behavior string into event handlers
        window.parseHyperscriptBehavior = function(behavior) {
            const handlers = [];
            const singleMatch = behavior.match(/^on\\s+(\\w+)\\s+(.+)$/);
            if (singleMatch) {
                handlers.push({
                    event: singleMatch[1],
                    command: singleMatch[2].trim()
                });
            }
            return handlers;
        };

        // Update summary stats after tests run
        function updateSummary() {
            const stats = mocha.stats || { passes: 0, failures: 0, tests: 0 };
            document.getElementById('passed').textContent = stats.passes || 0;
            document.getElementById('failed').textContent = stats.failures || 0;
            document.getElementById('total').textContent = stats.tests || 0;
            
            const percent = stats.tests > 0 ? Math.round((stats.passes / stats.tests) * 100) : 0;
            document.getElementById('percent').textContent = percent + '%';
        }
        
        // Update summary every second during test run
        setInterval(updateSummary, 1000);
    </script>

    <!-- 
    ==========================================================================
    OFFICIAL _HYPERSCRIPT TEST SUITE FILES
    Load all test files from the official _hyperscript test suite
    ==========================================================================
    -->
    
    <!-- CORE TESTS -->
    <!-- We'll load these via script tags pointing to the _hyperscript test files -->
    
    <!-- EXPRESSION TESTS -->
    <script>
        // For now, let's start with a few key test categories to validate the approach
        // We'll load the actual test files via HTTP requests to avoid CORS issues
        
        console.log("ðŸš€ Loading official _hyperscript test suite...");
        console.log("Available functions:", {
            evalHyperScript: typeof window.evalHyperScript,
            make: typeof window.make,
            clearWorkArea: typeof window.clearWorkArea
        });
    </script>

    <!-- Run the tests -->
    <script>
        // We'll need to dynamically load the test files
        // For now, let's add a simple test to verify our setup works
        
        describe("HyperFixi Setup Validation", function() {
            it("should have evalHyperScript available", function() {
                (typeof window.evalHyperScript).should.equal('function');
            });
            
            it("should have make function available", function() {
                (typeof window.make).should.equal('function');
            });
            
            it("should be able to evaluate simple expressions", async function() {
                const result = await window.evalHyperScript('"hello world"');
                result.should.equal('hello world');
            });
            
            it("should be able to create elements with make", function() {
                const element = window.make('<div id="test">Hello</div>');
                element.tagName.should.equal('DIV');
                element.id.should.equal('test');
                element.textContent.should.equal('Hello');
            });
        });

        // Run the test suite
        mocha.run();
    </script>
</body>
</html>