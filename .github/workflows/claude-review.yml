name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize]

concurrency:
  group: claude-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-sonnet-4-20250514
          prompt: |
            Review this pull request for the LokaScript monorepo. Focus on:

            1. **Code quality**: TypeScript type safety, no unnecessary `any` types
            2. **Test coverage**: Are new/changed code paths tested?
            3. **Bundle size**: Changes in packages/core/dist/ or packages/semantic/dist/ â€” flag potential size increases
            4. **Security**: No eval(), no injection vectors, no exposed secrets
            5. **Breaking changes**: Any public API modifications in packages/core/src/api/ or exported types
            6. **Pattern adherence**: Commands should follow CommandImplementation<TInput, TOutput, TypedExecutionContext>
            7. **Documentation**: If public APIs changed, is CLAUDE.md or API.md updated?

            Provide structured feedback with inline comments on specific lines where issues are found.
            Categorize findings as: Critical (must fix), Warning (should fix), Suggestion (nice to have).
          allowed_tools: |
            Bash(npm run typecheck:*),Bash(npm test:*),Read,Grep,Glob
