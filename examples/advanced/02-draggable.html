<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced 02: Draggable Elements - HyperFixi Examples</title>
    <link rel="stylesheet" href="../gallery.css">
    <style>
        /* Example-specific styles */
        .draggable-container {
            position: relative;
            min-height: 450px;
            background: var(--color-bg);
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-5);
        }

        .draggable-item {
            position: absolute;
            width: 220px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: move;
            user-select: none;
            transition: box-shadow var(--transition-base);
        }

        .draggable-item.dragging {
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .titlebar {
            background: var(--color-accent);
            color: white;
            padding: var(--space-3);
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            cursor: move;
            font-weight: bold;
        }

        .content {
            padding: var(--space-4);
            color: var(--color-text);
        }

        #item1 {
            top: 20px;
            left: 20px;
        }

        #item2 {
            top: 20px;
            left: 280px;
        }

        #item3 {
            top: 200px;
            left: 20px;
        }

        .instructions {
            background: var(--color-accent-muted);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            margin: var(--space-5) 0;
            color: var(--color-text);
            font-weight: 500;
        }

        .success-badge {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: var(--space-2) var(--space-4);
            border-radius: 20px;
            font-size: var(--text-xs);
            font-weight: bold;
            margin-left: var(--space-3);
        }

        .note {
            background: var(--color-accent-muted);
            border-left: 4px solid var(--color-accent);
            padding: var(--space-4);
            margin: var(--space-5) 0;
            border-radius: var(--radius-sm);
            color: var(--color-text);
        }
    </style>
</head>
<body class="example-page">
    <div class="page-container">
        <div class="breadcrumb">
            <a href="../index.html">← Back to Gallery</a> / <strong>Advanced</strong> / 02: Draggable Elements
        </div>

        <h1>Draggable Elements <span class="success-badge">PURE HYPERSCRIPT</span></h1>

        <div class="description">
            <strong>Reusable behavior with parameters and custom events</strong><br>
            This example shows how to create a reusable "Draggable" behavior that can be installed
            on any element, with support for custom drag handles, event hooks, and smooth positioning.
        </div>

        <div>
            <span class="tag advanced">behavior</span>
            <span class="tag advanced">install</span>
            <span class="tag feature">measure</span>
            <span class="tag feature">custom events</span>
            <span class="tag feature">halt event</span>
        </div>

        <!-- Demo -->
        <div class="demo">
            <div class="instructions">
                Instructions: <strong>Drag the boxes</strong> by their title bars. Notice the shadow effect during dragging!
            </div>

            <div class="draggable-container">
                <div id="item1" class="draggable-item"
                     _="install Draggable(dragHandle: .titlebar in me)
                        on draggable:start add .dragging
                        on draggable:end remove .dragging">
                    <div class="titlebar">Draggable Item 1</div>
                    <div class="content">Drag me by the title bar!</div>
                </div>

                <div id="item2" class="draggable-item"
                     _="install Draggable(dragHandle: .titlebar in me)
                        on draggable:start add .dragging
                        on draggable:end remove .dragging">
                    <div class="titlebar">Draggable Item 2</div>
                    <div class="content">I'm draggable too!</div>
                </div>

                <div id="item3" class="draggable-item"
                     _="install Draggable(dragHandle: .titlebar in me)
                        on draggable:start add .dragging
                        on draggable:end remove .dragging">
                    <div class="titlebar">Draggable Item 3</div>
                    <div class="content">Move me around!</div>
                </div>
            </div>
        </div>

        <!-- Code Explanation -->
        <h2>The Behavior Definition</h2>
        <div class="code">
<span class="keyword">behavior</span> Draggable(dragHandle)
  <span class="keyword">init</span>
    <span class="keyword">if no</span> dragHandle <span class="keyword">set the</span> dragHandle <span class="keyword">to</span> me
  <span class="keyword">end</span>

  <span class="keyword">on</span> pointerdown(clientX, clientY) <span class="keyword">from</span> dragHandle
    <span class="keyword">halt the event</span>        <span class="comment">-- Prevent text selection</span>
    <span class="keyword">trigger</span> draggable:start  <span class="comment">-- Custom event hook</span>

    <span class="keyword">measure</span> x
    <span class="keyword">set</span> startX <span class="keyword">to</span> it
    <span class="keyword">measure</span> y
    <span class="keyword">set</span> startY <span class="keyword">to</span> it

    <span class="keyword">set</span> xoff <span class="keyword">to</span> clientX - startX
    <span class="keyword">set</span> yoff <span class="keyword">to</span> clientY - startY

    <span class="keyword">repeat until</span> <span class="keyword">event</span> pointerup <span class="keyword">from</span> document
      <span class="keyword">wait for</span> pointermove(clientX, clientY) <span class="keyword">or</span>
                 pointerup(clientX, clientY) <span class="keyword">from</span> document

      <span class="keyword">add</span> <span class="string">{ left: ${clientX - xoff}px; top: ${clientY - yoff}px; }</span>
      <span class="keyword">trigger</span> draggable:move  <span class="comment">-- During drag</span>
    <span class="keyword">end</span>

    <span class="keyword">trigger</span> draggable:end      <span class="comment">-- Drag complete</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
        </div>

        <h2>Usage Example</h2>
        <div class="code">
&lt;div class=<span class="string">"draggable-item"</span>
     <span class="keyword">_</span>=<span class="string">"install Draggable(dragHandle: .titlebar in me)
        on draggable:start add .dragging
        on draggable:end remove .dragging"</span>&gt;

  &lt;div class=<span class="string">"titlebar"</span>&gt;Draggable Item&lt;/div&gt;
  &lt;div class=<span class="string">"content"</span>&gt;Drag me!&lt;/div&gt;
&lt;/div&gt;
        </div>

        <div class="explanation">
            <h3>How it works:</h3>
            <ol>
                <li><strong>Install behavior:</strong> <code>install Draggable(dragHandle: .titlebar in me)</code></li>
                <li><strong>Initialize:</strong> If no drag handle specified, use the element itself</li>
                <li><strong>Capture start:</strong> On pointerdown, measure current position and calculate offset</li>
                <li><strong>Track movement:</strong> Loop until pointerup from document, updating position on each pointermove</li>
                <li><strong>Custom events:</strong> Trigger draggable:start, draggable:move, draggable:end for hooks</li>
                <li><strong>CSS injection:</strong> Use template strings to add position styles directly</li>
            </ol>

            <h3>Advanced Concepts:</h3>
            <ul>
                <li><strong>Behaviors:</strong> Reusable components that encapsulate logic</li>
                <li><strong>Parameters:</strong> <code>Draggable(dragHandle)</code> accepts configuration</li>
                <li><strong>init block:</strong> Runs once when behavior is installed</li>
                <li><strong>measure:</strong> Get element dimensions and position</li>
                <li><strong>halt the event:</strong> Prevent default behavior and stop propagation</li>
                <li><strong>Event listening:</strong> <code>from document</code> listens for pointer events at document level</li>
                <li><strong>Custom events:</strong> <code>trigger eventName</code> for lifecycle hooks</li>
                <li><strong>Event parameters:</strong> Destructure event properties in handler signature</li>
            </ul>

            <h3>Custom Event Hooks:</h3>
            <ul>
                <li><code>draggable:start</code> - Fired when drag begins (great for adding visual feedback)</li>
                <li><code>draggable:move</code> - Fired during each movement (could track distance, log position)</li>
                <li><code>draggable:end</code> - Fired when drag completes (save state, check drop zones)</li>
            </ul>

            <h3>Try it yourself:</h3>
            <ul>
                <li>Add boundaries: Check position limits before applying styles</li>
                <li>Snap to grid: Round positions to nearest 20px</li>
                <li>Drop zones: Use draggable:end to check if element is over a target</li>
                <li>Multiple behaviors: Install other behaviors alongside Draggable</li>
            </ul>
        </div>

        <div class="note">
            <strong>Key insight about event flow:</strong> The behavior listens for pointer events <code>from document</code> rather than
            just <code>from dragHandle</code>. This ensures the drag continues smoothly even when the pointer moves quickly and temporarily
            leaves the drag handle's bounds. The <code>halt the event</code> on pointerdown prevents text selection during drag.
        </div>

        <div class="note">
            <strong>Note about behaviors:</strong> The <code>behavior</code> feature requires full hyperscript implementation.
            If dragging doesn't work yet, it indicates the behavior system needs implementation. The behavior code above is defined
            in a <code>&lt;script type="text/hyperscript"&gt;</code> tag at the bottom of this page.
        </div>

        <!-- Navigation -->
        <div class="nav-buttons">
            <a href="01-color-cycling.html">← Previous: Color Cycling</a>
            <a href="../../compound-examples.html">View All Advanced Examples →</a>
        </div>
    </div>

    <!-- Load HyperFixi -->
    <script src="../bundle-loader.js"></script>
    <script src="../prism-loader.js"></script>
    <script src="../bundle-selector.js"></script>
    <script src="../debug-panel.js"></script>

    <!-- Define Draggable Behavior -->
    <script type="text/hyperscript">
behavior Draggable(dragHandle)
  init
    if no dragHandle set the dragHandle to me
  end
  on pointerdown(clientX, clientY) from dragHandle
    halt the event
    trigger draggable:start

    measure x
    set startX to it
    measure y
    set startY to it
    set xoff to clientX - startX
    set yoff to clientY - startY
    repeat until event pointerup from document
      wait for pointermove(clientX, clientY) or
               pointerup(clientX, clientY) from document
      add { left: ${clientX - xoff}px; top: ${clientY - yoff}px; }
      trigger draggable:move
    end

    trigger draggable:end
  end
end
    </script>
</body>
</html>
